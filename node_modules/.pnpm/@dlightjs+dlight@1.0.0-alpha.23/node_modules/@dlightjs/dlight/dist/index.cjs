"use strict";var _=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var G=(s,e)=>{for(var t in e)_(s,t,{get:e[t],enumerable:!0})},q=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of B(e))!R.call(s,o)&&o!==t&&_(s,o,{get:()=>e[o],enumerable:!(n=V(e,o))||n.enumerable});return s};var z=s=>q(_({},"__esModule",{value:!0}),s);var se={};G(se,{$:()=>ne,CompNode:()=>A,CondNode:()=>I,EnvNode:()=>H,ExpNode:()=>$,ForNode:()=>L,PropView:()=>S,View:()=>X,createElement:()=>Q,createTemplate:()=>J,createTextNode:()=>Z,escape:()=>U,forwardHTMLProp:()=>D,insertNode:()=>b,manual:()=>te,render:()=>ee,setDataset:()=>P,setEvent:()=>O,setHTMLAttr:()=>T,setHTMLAttrs:()=>W,setHTMLProp:()=>x,setHTMLProps:()=>C,setStyle:()=>F,update:()=>Y,updateText:()=>k});module.exports=z(se);var d=class{_$dlNodeType;constructor(e){this._$dlNodeType=e}get _$el(){return d.toEls(this._$nodes)}_$parentEl;_$nodes;static toEls(e){let t=[];return this.loopShallowEls(e,n=>{t.push(n)}),t}static loopDLNodes(e,t){e.forEach(n=>{t(n),n._$nodes&&d.loopDLNodes(n._$nodes,t)})}static loopDLNodesInsideOut(e,t){e.forEach(n=>{n._$nodes&&d.loopDLNodesInsideOut(n._$nodes,t),t(n)})}static loopShallowEls(e,t){e.forEach(n=>{if(!("_$dlNodeType"in n))return t(n);n._$nodes&&d.loopShallowEls(n._$nodes,t)})}static loopShallowDLNodes(e,t){e.forEach(n=>{"_$dlNodeType"in n&&(t(n),n._$nodes&&d.loopShallowDLNodes(n._$nodes,t))})}static addParentEl(e,t){this.loopShallowDLNodes(e,n=>{n._$parentEl=t})}static getFlowIndexFromNodes(e,t){let n=0,o=[...e];for(;o.length>0;){let i=o.shift();if(i===t)break;"_$dlNodeType"in i?i._$nodes&&o.unshift(...i._$nodes):n++}return n}static appendNodesWithSibling(e,t,n){return n?this.insertNodesBefore(e,t,n):this.appendNodes(e,t)}static appendNodesWithIndex(e,t,n,o){return o=o??t.childNodes.length,o!==n?this.insertNodesBefore(e,t,t.childNodes[n]):this.appendNodes(e,t)}static insertNodesBefore(e,t,n){let o=0;return this.loopShallowEls(e,i=>{t.insertBefore(i,n),o++}),o}static appendNodes(e,t){let n=0;return this.loopShallowEls(e,o=>{t.appendChild(o),n++}),n}static willUnmountFunc(e,t){e(),t?.()}static addWillUnmount(e,t){e.willUnmount=this.willUnmountFunc.bind(this,t,e.willUnmount)}};function F(s,e){Object.entries(e).forEach(([t,n])=>{s.style[t]=n})}function P(s,e){Object.entries(e).forEach(([t,n])=>{s.dataset[t]=n})}function x(s,e,t){let n=`$${e}`;n in s&&s[n]===t||(s[e]=t,s[n]=t)}function C(s,e){Object.entries(e).forEach(([t,n])=>{x(s,t,n)})}function T(s,e,t){let n=`$${e}`;n in s&&s[n]===t||(s.setAttribute(e,t),s[n]=t)}function W(s,e){Object.entries(e).forEach(([t,n])=>{T(s,t,n)})}function O(s,e,t){let n=s[`$on${e}`];n&&s.removeEventListener(e,n),s.addEventListener(e,t),s[`$on${e}`]=t}function J(s){let e=document.createElement("template");e.innerHTML=s;let t=e.content.firstChild;return()=>t.cloneNode(!0)}function Q(s){return document.createElement(s)}function b(s,e,t){s._$nodes||(s._$nodes=Array.from(s.childNodes)),s._$nodes.splice(t,0,e),d.appendNodesWithIndex([e],s,t),d.addParentEl([e],s)}function D(s,e,t){if(e==="style"){F(s,t);return}if(e==="dataset"){P(s,t);return}if(e!=="element"){if(e==="prop"){C(s,t);return}if(e==="attr"){W(s,t);return}if(e==="innerHTML"){x(s,"innerHTML",t);return}if(e!=="forwardProp"){if(e.startsWith("on")){O(s,e.slice(2).toLowerCase(),t);return}T(s,e,t)}}}var A=class extends d{constructor(){super(0)}_$init(e,t,n,o){o&&o._$addForwardProps(this),t!==null&&this._$setContent(t),e&&Object.entries(e).forEach(([i,c])=>{this._$setProp(i,c)}),n&&(this._$children=n),Object.entries(window.DLEnvStore.envs).forEach(([i,[c,p]])=>{p.addNode(this),this._$initEnv(i,c,p)}),this._$callUpdatesBeforeInit(),this.willMount?.(),this._$nodes=this.View?.()??[],this.didMount?.()}_$callUpdatesBeforeInit(){let e=Object.getOwnPropertyNames(Object.getPrototypeOf(this)),t=Object.getOwnPropertyNames(this);[...e,...t].forEach(o=>{if(o.startsWith("$w$"))return this[o.slice(3)]();o.startsWith("$f$")&&(this[`$${o.slice(3)}`]=this[o])})}_$setForwardProp(e,t){if(e in this){this[e]=t;return}this._$forwardPropsId.push(e);let n=`$${e}`;this[n]=t,Object.defineProperty(this,e,{get(){return this[n]},set(o){this[n]!==o&&(this[n]=o,this._$forwardPropsSet?.forEach(i=>{i._$dlNodeType===0&&i._$setProp(e,o),i instanceof HTMLElement&&D(i,e,o)}))}})}_$addForwardProps(e){this._$forwardPropsSet.add(e),this._$forwardPropsId.forEach(t=>{let n=this[t];this._$forwardPropsSet?.forEach(o=>{o._$dlNodeType===0&&("_$forwardProps"in o&&o._$forwardPropsId.push(t),o._$setProp(t,n)),o instanceof HTMLElement&&D(o,t,n)})}),d.addWillUnmount(e,this._$forwardPropsSet.delete.bind(this._$forwardPropsSet,e))}_$setProp(e,t){"_$forwardProps"in this&&this._$setForwardProp(e,t),`$p$${e}`in this&&(this[e]=t)}_$initEnv(e,t,n){`$e$${e}`in this&&(this[e]=t,this[`$en$${e}`]=n)}_$updateEnv(e,t,n){`$e$${e}`in this&&n===this[`$en$${e}`]&&this[e]!==t&&(this[e]=t)}_$setContent(e){let t=this._$contentKey;t&&this[t]!==e&&(this[t]=e)}_$updateProp(e,t){let n=`$${e}`;this[n]!==t&&(this[n]=t,this._$updateDerived(e),this._$updateView(e))}_$updateDerived(e){this._$nodes&&this[`$s$${e}`]?.forEach(t=>{`$w$${t}`in this?this[t]():this[`$${t}`]=this[`$f$${t}`]})}_$updateView(e){let t=this[`$$${e}`];t&&this._$update?.(t)}},X=A;function Y(s,e){s._$updateDerived(e),s._$updateView(e)}var a=class extends d{constructor(e){super(e),window.DLEnvStore.currentEnvNodes.length>0&&(this.savedEnvNodes=[...window.DLEnvStore.currentEnvNodes])}initNewNodes(e){d.addParentEl(e,this._$parentEl)}geneNewNodesInEnv(e){if(!this.savedEnvNodes){let o=e();return this.initNewNodes(o),o}let t=window.DLEnvStore.currentEnvNodes;window.DLEnvStore.replaceEnvNodes(this.savedEnvNodes);let n=e();return window.DLEnvStore.replaceEnvNodes(t),this.initNewNodes(n),n}removeNodes(e){d.loopDLNodes(e,t=>t.willUnmount?.()),d.loopShallowEls(e,t=>{this._$parentEl?.removeChild(t)}),d.loopDLNodesInsideOut(e,t=>t.didUnmount?.())}};var L=class extends a{array;keys;nodeFunc;nodess;depNum;constructor(e,t,n,o){super(1),this.array=[...e],this.nodeFunc=t,this.keys=o,this.depNum=n,this.nodess=this.array.map(i=>t(i)),this._$nodes=this.nodess.flat(1)}update(e){if(!(e&this.depNum))for(let t=0;t<this.array.length;t++)this.updateItem(this.nodess[t],this.array[t],e)}updateItem(e,t,n){e[0]._$updateFunc?.(n??this.depNum,t)}updateArray(e,t){if(t){this.updateWithKey(e,t);return}this.updateWithOutKey(e)}getNewNodes(e){return this.geneNewNodesInEnv(()=>this.nodeFunc(this.array[e]))}updateWithOutKey(e){let t=this.array.length,n=e.length;if(this.array=[...e],t===n){for(let i=0;i<this.array.length;i++)this.updateItem(this.nodess[i],this.array[i]);return}let o=this._$parentEl;if(t<n){let i=a.getFlowIndexFromNodes(o._$nodes,this),c=o.childNodes.length;for(let p=0;p<n;p++){if(p<t){i+=a.getFlowIndexFromNodes(this.nodess[p]),this.updateItem(this.nodess[p],this.array[p]);continue}let l=this.getNewNodes(p);a.appendNodesWithIndex(l,o,i,c),this.nodess.push(l)}this._$nodes=this.nodess.flat(1);return}for(let i=0;i<n;i++)this.updateItem(this.nodess[i],this.array[i]);for(let i=n;i<t;i++)this.removeNodes(this.nodess[i]);this.nodess=this.nodess.slice(0,n),this._$nodes=this.nodess.flat(1)}updateWithKey(e,t){let n=this.keys,o=this.array;if(this.array=[...e],this.keys=t,L.arrayEqual(n,this.keys)){for(let r=0;r<this.array.length;r++)this.updateItem(this.nodess[r],this.array[r]);return}let i=this._$parentEl,c=this.nodess;if(this.keys.length===0){let r=i._$nodes??[];if(r.length===1&&r[0]===this)i.innerHTML="";else for(let h=0;h<n.length;h++)this.removeNodes(c[h]);this.nodess=[],this._$nodes=[];return}let p=a.getFlowIndexFromNodes(i._$nodes,this);if(n.length===0){let r=i.childNodes[p];for(let h=0;h<this.keys.length;h++){let u=this.getNewNodes(h);a.appendNodesWithSibling(u,i,r),this.nodess.push(u)}this._$nodes=this.nodess.flat(1);return}let l=[],N=[],K=[];for(let r=0;r<n.length;r++){let h=n[r];if(this.keys.includes(h)){l.push(h),N.push(c[r]),K.push(o[r]);continue}this.removeNodes(c[r])}let y=i.childNodes.length,f=p;for(let r=0;r<this.keys.length;r++){let h=this.keys[r],u=l.indexOf(h);if(u!==-1){f+=a.getFlowIndexFromNodes(N[u]),this.updateItem(N[u],this.array[r]);continue}let m=this.getNewNodes(r),E=a.appendNodesWithIndex(m,i,f,y);f+=E,y+=E,N.splice(r,0,m),l.splice(r,0,h)}if(L.arrayEqual(this.keys,l)){this.nodess=N,this._$nodes=this.nodess.flat(1);return}f=p;let g=[];for(let r=0;r<this.keys.length;r++){let h=this.keys[r],u=l.indexOf(h),m=g[r];if(m){let v=a.appendNodesWithIndex(m,i,f+a.getFlowIndexFromNodes(m),y);f+=v,y+=v,g[r]=void 0}else if(u===r){f+=a.getFlowIndexFromNodes(N[r]);continue}else{g[this.keys.indexOf(l[r])]=N[r];let v=a.appendNodesWithIndex(N[u],i,f,y);f+=v,y+=v}let E=N[r];N[r]=N[u],N[u]=E;let j=l[r];l[r]=l[u],l[u]=j}this.nodess=N,this._$nodes=this.nodess.flat(1)}static arrayEqual(e,t){return e.length!==t.length?!1:e.every((n,o)=>n===t[o])}};var $=class extends a{nodesFunc;constructor(e){super(4),this.nodesFunc=e,this._$nodes=$.formatNodes(e())}update(){let e=this.geneNewNodesInEnv(()=>$.formatNodes(this.nodesFunc()));if(this.removeNodes(this._$nodes),e.length===0){this._$nodes=[];return}let t=this._$parentEl,n=a.getFlowIndexFromNodes(t._$nodes,this),o=t.childNodes[n];a.appendNodesWithSibling(e,t,o),this._$nodes=e}static formatNodes(e){return Array.isArray(e)||(e=[e]),e.flat(1).filter(t=>t!=null&&typeof t!="boolean").map(t=>typeof t=="string"||typeof t=="number"||typeof t=="bigint"?document.createTextNode(`${t}`):"propViewFunc"in t?t.build():t).flat(1)}};var I=class extends a{condFunc;cond;depNum;constructor(e,t){super(2),this.condFunc=e,this.depNum=t,this.cond=-1,this._$nodes=this.condFunc(this)}updateCond(){let e=this.geneNewNodesInEnv(()=>this.condFunc(this));if(this.didntChange)return this.didntChange=!1,this.updateChildren();if(this._$nodes&&this._$nodes.length>0&&this.removeNodes(this._$nodes),this.cond===-1){this._$nodes=[];return}let t=this._$parentEl,n=a.getFlowIndexFromNodes(t._$nodes,this),o=t.childNodes[n];a.appendNodesWithSibling(e,t,o),this._$nodes=e}updateChildren(e){this._$nodes[0]?._$updateFunc?.(e??this.depNum)}update(e){e&this.depNum||this.updateChildren(e)}};var M=class{envs={};currentEnvNodes=[];addEnvNode(e){this.currentEnvNodes.push(e),this.mergeEnvs()}replaceEnvNodes(e){this.currentEnvNodes=e,this.mergeEnvs()}removeEnvNode(){this.currentEnvNodes.pop(),this.mergeEnvs()}mergeEnvs(){this.envs={},this.currentEnvNodes.forEach(e=>{Object.entries(e.envs).forEach(([t,n])=>{this.envs[t]=[n,e]})})}};window.DLEnvStore||(window.DLEnvStore=new M);var H=class extends d{updateNodes=new Set;envs;constructor(e){super(3),this.envs=e,window.DLEnvStore.addEnvNode(this)}updateEnv(e,t){this.envs[e]=t,this.updateNodes.forEach(n=>{n._$updateEnv(e,t,this)})}addNode(e){this.updateNodes.add(e),d.addWillUnmount(e,this.updateNodes.delete.bind(this.updateNodes,e))}initNodes(e){this._$nodes=e,window.DLEnvStore.removeEnvNode()}};function Z(s){return document.createTextNode(s)}function k(s,e){s.textContent!==e&&(s.textContent=e)}var S=class{propViewFunc;dlUpdateNodes=new Set;constructor(e){this.propViewFunc=e}build(){let e=this.propViewFunc();if(e.length===0)return[];let t=e[0];return this.dlUpdateNodes.add(t),d.addWillUnmount(t,this.dlUpdateNodes.delete.bind(this.dlUpdateNodes,t)),e}update(e){this.dlUpdateNodes.forEach(t=>{t._$updateFunc?.(e)})}};function ee(s,e){let t=s;if(typeof s=="string"){let o=document.getElementById(s);if(o)t=o;else throw new Error(`DLight: Element with id ${s} not found`)}t.innerHTML="";let n=new e;b(t,n,0)}function te(s,e){return s()}function U(s){return s}var ne=U;0&&(module.exports={$,CompNode,CondNode,EnvNode,ExpNode,ForNode,PropView,View,createElement,createTemplate,createTextNode,escape,forwardHTMLProp,insertNode,manual,render,setDataset,setEvent,setHTMLAttr,setHTMLAttrs,setHTMLProp,setHTMLProps,setStyle,update,updateText});
//# sourceMappingURL=index.cjs.map