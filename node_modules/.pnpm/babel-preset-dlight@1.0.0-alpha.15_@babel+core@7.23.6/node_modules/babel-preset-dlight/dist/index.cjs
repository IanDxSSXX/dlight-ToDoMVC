"use strict";var V=Object.create;var y=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var $=(l,e,t)=>e in l?y(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var F=(l,e)=>{for(var t in e)y(l,t,{get:e[t],enumerable:!0})},M=(l,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of L(e))!j.call(l,s)&&s!==t&&y(l,s,{get:()=>e[s],enumerable:!(i=O(e,s))||i.enumerable});return l};var w=(l,e,t)=>(t=l!=null?V(T(l)):{},M(e||!l||!l.__esModule?y(t,"default",{value:l,enumerable:!0}):t,l)),R=l=>M(y({},"__esModule",{value:!0}),l);var m=(l,e,t)=>($(l,typeof e!="symbol"?e+"":e,t),t);var H={};F(H,{default:()=>_});module.exports=R(H);var A=w(require("babel-plugin-syntax-typescript-new"),1),D=w(require("@babel/plugin-syntax-decorators"),1);var C=require("minimatch"),E=require("@dlightjs/view-parser"),b=require("@dlightjs/reactivity-parser"),g=require("@dlightjs/view-generator");var I=process.env.NODE_ENV==="development",c=class{dlightPackageName=c.dlightDefaultPackageName;babelApi;t;traverse;enableDevTools;includes;excludes;htmlTags;constructor(e,t,i,s,r,n){this.babelApi=e,this.t=t,this.traverse=e.traverse,this.includes=i,this.excludes=s,this.enableDevTools=I&&r,this.htmlTags=typeof n=="function"?n(c.defaultHTMLTags):n.includes("*")?[...new Set([...c.defaultHTMLTags,...n])].filter(a=>a!=="*"):n}classRootPath;classDeclarationNode;classBodyNode;constructorNode;propertiesContainer={};dependencyMap={};enter=!0;enterClassNode=!1;className;programNode;allImports=[];didAlterImports=!1;clearNode(){this.classRootPath=void 0,this.classDeclarationNode=void 0,this.classBodyNode=void 0,this.constructorNode=void 0,this.propertiesContainer={},this.dependencyMap={},this.enter=!0,this.enterClassNode=!1,this.className=void 0}get availableProperties(){return Object.entries(this.propertiesContainer).filter(([e,{isWatcher:t,isStatic:i,isChildren:s}])=>e!=="_$compName"&&!t&&!i&&!s).map(([e])=>e)}initNode(e){this.classRootPath=e;let t=e.node;if(this.classDeclarationNode=t,this.classBodyNode=t.body,this.propertiesContainer={},t.id?.name||(t.id=this.t.identifier(`Anonymous_${c.uid()}`)),this.className=t.id?.name,this.handleClassCustomDecorators(),this.enableDevTools&&this.classBodyNode.body.unshift(this.t.classProperty(this.t.identifier("_$compName"),this.t.stringLiteral(this.className))),this.addConstructor(),!this.didAlterImports){let i=this.allImports.filter(s=>s.source.value===c.dlightDefaultPackageName);this.dlightPackageName!==c.dlightDefaultPackageName&&i.forEach(s=>{s.source.value=this.dlightPackageName}),this.programNode.body.unshift(this.t.importDeclaration(Object.entries(c.importMap).map(([s,r])=>this.t.importSpecifier(this.t.identifier(r),this.t.identifier(s))),this.t.stringLiteral(this.dlightPackageName))),this.didAlterImports=!0}}enterProgram(e){}programEnterVisitor(e,t){if(this.enter=this.fileAllowed(t),!this.enter)return;if(this.allImports=e.node.body.filter(s=>this.t.isImportDeclaration(s)),this.allImports.filter(s=>s.source.value===c.dlightDefaultPackageName).length===0){this.enter=!1;return}this.programNode=e.node,this.enterProgram(e)}exitProgram(e){}programExitVisitor(e){this.enter&&(this.didAlterImports=!1,this.allImports=[],this.programNode=void 0,this.exitProgram(e))}enterClass(e){}classEnter(e){this.enter&&(this.enterClassNode=this.isDLightView(e),this.enterClass&&(this.initNode(e),this.enterClass(e)))}exitClass(e){}classExit(e){this.enter&&this.enterClassNode&&(this.transformDLightClass(),this.addInit(),this.exitClass(e),this.clearNode(),this.enterClassNode=!1)}visitClassMethod(e){}classMethodVisitor(e){if(!this.enterClassNode||!this.t.isIdentifier(e.node.key))return;let t=e.node.key.name;if(t==="View"||this.findDecoratorByName(e.node.decorators,"View"))return;let s=e.node,r=this.findDecoratorByName(s.decorators,"Watch");if(!r){if(this.t.isIdentifier(s.key,{name:"constructor"}))return;this.autoBindMethods(s);return}let n=[];if(this.t.isIdentifier(r))n=this.getDependencies(e);else{let a=r.arguments[0];this.t.isArrayExpression(a)&&(n=a.elements.filter(o=>this.t.isStringLiteral(o)).map(o=>o.value),n=[...new Set(n)])}this.propertiesContainer[t]={node:s,deps:n,isWatcher:!0},s.decorators=this.removeDecorators(s.decorators,["Watch"]),this.visitClassMethod(e)}visitClassProperty(e){}classPropertyVisitor(e){if(!this.enterClassNode)return;let t=e.node;if(!this.t.isIdentifier(t.key))return;let i=t.key.name;if(i==="View")return;let s=t.decorators;if(this.findDecoratorByName(s,"View"))return;let n=!!this.findDecoratorByName(s,"Prop"),a=!!this.findDecoratorByName(s,"Env"),o=!!this.findDecoratorByName(t.decorators,"Children"),d=o?[]:this.getDependencies(e);this.propertiesContainer[i]={node:t,deps:d,isStatic:!!this.findDecoratorByName(s,"Static"),isContent:!!this.findDecoratorByName(s,"Content"),isChildren:o,isPropOrEnv:n?"Prop":a?"Env":void 0},t.decorators=this.removeDecorators(s,c.availableDecoNames),this.visitClassProperty(e)}resolveWatcherDecorator(e){if(!this.t.isIdentifier(e.key))return;let t=e.key.name,i=this.classBodyNode.body.indexOf(e),s=this.t.classProperty(this.t.identifier(`$w$${t}`));this.classBodyNode.body.splice(i,0,s)}resolveChildrenDecorator(e){if(!this.classBodyNode||!this.t.isIdentifier(e.key))return;let t=e.key.name,i=this.classBodyNode.body.indexOf(e),s=this.t.memberExpression(this.t.thisExpression(),this.t.identifier("_$children")),r=this.t.classMethod("get",this.t.identifier(t),[],this.t.blockStatement([this.t.returnStatement(s)]));this.classBodyNode.body.splice(i,1,r)}resolveContentDecorator(e){if(!this.classBodyNode||!this.t.isIdentifier(e.key)||this.classBodyNode.body.some(r=>this.t.isClassProperty(r)&&r.key.name==="_$contentKey"))return;let t=e.key.name,i=this.classBodyNode.body.indexOf(e),s=this.t.classProperty(this.t.identifier("_$contentKey"),this.t.stringLiteral(t));this.classBodyNode.body.splice(i,0,s)}resolvePropDecorator(e,t){if(!this.classBodyNode||!this.t.isIdentifier(e.key))return;let i=e.key.name,s=this.classBodyNode.body.indexOf(e),r=t.toLowerCase()==="prop"?"p":"e",n=this.t.classProperty(this.t.identifier(`$${r}$${i}`));this.classBodyNode.body.splice(s,0,n)}resolveStateDecorator(e,t,i){if(!this.classBodyNode||!this.t.isIdentifier(e.key))return;let s=e.key.name;e.key.name=`$${s}`;let r=this.classBodyNode.body.indexOf(e),n=this.t.classProperty(this.t.identifier(`$$${s}`),this.t.numericLiteral(1<<t)),a=i?[this.t.classProperty(this.t.identifier(`$s$${s}`),this.t.arrayExpression([...i].map(h=>this.t.stringLiteral(h))))]:[],o=this.t.classMethod("get",this.t.identifier(s),[],this.t.blockStatement([this.t.returnStatement(this.t.memberExpression(this.t.thisExpression(),this.t.identifier(`$${s}`)))])),d=this.t.classMethod("set",this.t.identifier(s),[this.t.identifier("value")],this.t.blockStatement([this.t.expressionStatement(this.t.callExpression(this.t.memberExpression(this.t.thisExpression(),this.t.identifier("_$updateProp")),[this.t.stringLiteral(s),this.t.identifier("value")]))]));this.classBodyNode.body.splice(r+1,0,n,...a,o,d)}handleClassCustomDecorators(){if(!this.classBodyNode)return;let e=this.classDeclarationNode?.decorators;if(!e)return;this.findDecoratorByName(e,"ForwardProps")&&(this.classBodyNode.body.unshift(this.t.classProperty(this.t.identifier("_$forwardProps")),this.t.classProperty(this.t.identifier("_$forwardPropsSet"),this.t.newExpression(this.t.identifier("Set"),[])),this.t.classProperty(this.t.identifier("_$forwardPropsId"),this.t.arrayExpression([]))),this.classDeclarationNode.decorators=this.removeDecorators(e,["ForwardProps"]))}transformDLightClass(){let e=this.handleView(),t=Object.entries(this.propertiesContainer).reverse(),i=this.dependencyMapReversed();for(let[s,{node:r,deps:n,isStatic:a,isChildren:o,isPropOrEnv:d,isWatcher:h,isContent:p}]of t){if(o){this.resolveChildrenDecorator(r);continue}n.length>0&&(e.push(...n),h?this.resolveWatcherDecorator(r):this.handleDerivedProperty(r)),d&&this.resolvePropDecorator(r,d),p&&(this.resolvePropDecorator(r,"Prop"),this.resolveContentDecorator(r)),!a&&e.includes(s)&&this.resolveStateDecorator(r,this.availableProperties.indexOf(s),i[s])}}handleView(){if(!this.classBodyNode)return[];let e=new Set,t,i=[];for(let o of this.classBodyNode.body){if(!this.t.isClassProperty(o)&&!this.t.isClassMethod(o)||!this.t.isIdentifier(o.key))continue;let d=this.findDecoratorByName(o.decorators,"View"),h=o.key.name==="View";if(!(!d&&!h)){if(this.t.isClassProperty(o)){let p=o.value;for(;this.t.isTSAsExpression(p);)p=p.expression;if(!this.t.isArrowFunctionExpression(p))continue;o.value=p;let f=this.arrowFunctionPropertyToMethod(o);if(!f)continue;o=f}d?(o.decorators=null,i.push(o)):t=o}}let s=i.map(o=>o.key.name),r=Object.fromEntries(i.map(o=>{let d=o.params[0];if(!d||!this.t.isObjectPattern(d))return["-",null];let h=Object.fromEntries(d.properties.map(p=>{if(!this.t.isObjectProperty(p))return["-",null];let f=p.key.name,P=this.getIdentifiers(this.t.assignmentExpression("=",this.t.objectPattern([this.t.objectProperty(this.t.numericLiteral(0),p.value)]),this.t.numericLiteral(0))).filter(v=>v!==f);return[f,P]}).filter(([p,f])=>f));return[o.key.name,h]}).filter(([o,d])=>d)),n=-1;if(t){let o;[o,n]=this.alterMainView(t,s,r),o.forEach(e.add.bind(e))}i.forEach(o=>{let d;[d,n]=this.alterSubView(o,s,r,n),d.forEach(e.add.bind(e))});let a=[];return this.availableProperties.forEach(o=>{e.has(o)&&a.push(o)}),a}alterMainView(e,t,i){let s=(0,E.parseView)(e.body,{babelApi:this.babelApi,subviewNames:t,htmlTags:this.htmlTags}),[r,n]=(0,b.parseReactivity)(s,{babelApi:this.babelApi,availableProperties:this.availableProperties,dependencyMap:this.dependencyMap}),[a,o,d]=(0,g.generateView)(r,{babelApi:this.babelApi,className:this.className,importMap:c.importMap,subViewPropMap:Object.fromEntries(Object.entries(i).map(([h,p])=>[h,Object.keys(p)])),templateIdx:-1});return e.body=a,this.classBodyNode?.body.push(...o),[n,d]}alterSubView(e,t,i,s){let r=(0,E.parseView)(e.body,{babelApi:this.babelApi,subviewNames:t,htmlTags:this.htmlTags}),[n,a]=(0,b.parseReactivity)(r,{babelApi:this.babelApi,availableProperties:this.availableProperties,dependencyMap:this.dependencyMap}),o=i[e.key.name]??[],d={};Object.entries(o).forEach(([N,x])=>{x.forEach(B=>{d[B]=[N]})});let[h]=(0,b.parseReactivity)(r,{babelApi:this.babelApi,availableProperties:Object.keys(o),dependencyMap:this.dependencyMap,dependencyParseType:"identifier",identifierDepMap:d}),p=Object.fromEntries(Object.entries(i).map(([N,x])=>[N,Object.keys(x)])),[f,P,v]=(0,g.generateSubView)(n,h,e.params[0],{babelApi:this.babelApi,className:this.className,importMap:c.importMap,subViewPropMap:p,templateIdx:s});return e.body=f,this.classBodyNode?.body.push(...P),[a,v]}fileAllowed(e){return this.includes.includes("*")?!0:!(!e||this.excludes.some(t=>(0,C.minimatch)(e,t))||!this.includes.some(t=>(0,C.minimatch)(e,t)))}isDLightView(e){let t=e.node;return(t.decorators??[]).find(r=>this.t.isIdentifier(r.expression,{name:"View"}))&&(t.superClass=this.t.identifier("View"),t.decorators=t.decorators?.filter(r=>!this.t.isIdentifier(r.expression,{name:"View"}))),this.t.isIdentifier(t.superClass,{name:"View"})}removeDecorators(e,t){return e?e.filter(i=>!(this.t.isIdentifier(i.expression)&&t.includes(i.expression.name)||this.t.isCallExpression(i.expression)&&this.t.isIdentifier(i.expression.callee)&&t.includes(i.expression.callee.name))):[]}findDecoratorByName(e,t){if(e)return e.find(i=>this.t.isIdentifier(i.expression,{name:t})||this.t.isCallExpression(i.expression)&&this.t.isIdentifier(i.expression.callee,{name:t}))?.expression}addConstructor(){if(!this.classBodyNode)return;let e=this.classBodyNode.body.find(t=>this.t.isClassMethod(t,{kind:"constructor"}));if(e)throw new Error("DLight class should not have constructor");e=this.t.classMethod("constructor",this.t.identifier("constructor"),[this.t.identifier("props"),this.t.identifier("content"),this.t.identifier("children"),this.t.identifier("forwardPropsScope")],this.t.blockStatement([this.t.expressionStatement(this.t.callExpression(this.t.super(),[]))])),this.constructorNode=e,this.classBodyNode.body.unshift(e)}addInit(){this.constructorNode.body.body.push(this.t.expressionStatement(this.t.callExpression(this.t.memberExpression(this.t.thisExpression(),this.t.identifier("_$init")),[this.t.identifier("props"),this.t.identifier("content"),this.t.identifier("children"),this.t.identifier("forwardPropsScope")])))}autoBindMethods(e){this.constructorNode.body.body.push(this.t.expressionStatement(this.t.assignmentExpression("=",this.t.memberExpression(this.t.thisExpression(),e.key),this.t.callExpression(this.t.memberExpression(this.t.memberExpression(this.t.thisExpression(),e.key),this.t.identifier("bind")),[this.t.thisExpression()]))))}handleDerivedProperty(e){if(!this.t.isIdentifier(e.key))return;let t=e.key.name,i=e.value,s=this.classBodyNode.body.indexOf(e),r=this.t.classMethod("get",this.t.identifier(`$f$${t}`),[],this.t.blockStatement([this.t.returnStatement(i)]));this.classBodyNode.body.splice(s+1,0,r),e.value=null}getDependencies(e){let t=e.node;if(!this.t.isIdentifier(t.key))return[];let i=new Set,s=new Set;e.scope.traverse(t,{MemberExpression:a=>{if(!this.t.isIdentifier(a.node.property))return;let o=a.node.property.name;this.isAssignmentExpressionLeft(a)?s.add(o):this.availableProperties.includes(o)&&this.t.isThisExpression(a.node.object)&&!this.isMemberInEscapeFunction(a,this.classDeclarationNode)&&!this.isMemberInManualFunction(a,this.classDeclarationNode)&&!this.isAssignmentExpressionRight(a,this.classDeclarationNode)&&(i.add(o),this.dependencyMap[o]?.forEach(i.add.bind(i)))}}),s.forEach(i.delete.bind(i));let r=t.key.name,n=[...i];return i.size>0&&(this.dependencyMap[r]=n),n}dependencyMapReversed(){let e={};return Object.entries(this.dependencyMap).forEach(([t,i])=>{i.forEach(s=>{e[s]||(e[s]=new Set),e[s].add(t)})}),e}arrowFunctionPropertyToMethod(e){if(!this.t.isArrowFunctionExpression(e.value))return;let t=e.value;if(!this.t.isBlockStatement(t.body))return;let i=this.classBodyNode.body.indexOf(e),s=this.t.classMethod("method",e.key,t.params,t.body);return this.classBodyNode.body.splice(i,1,s),s}isMemberExpressionProperty(e,t){return this.t.isMemberExpression(e)&&!e.computed&&e.property===t}isObjectKey(e,t){return this.t.isObjectProperty(e)&&e.key===t}valueWithArrowFunc(e){e.value||(e.value=this.t.identifier("undefined")),e.value=this.t.arrowFunctionExpression([],e.value)}valueWrapper(e){return this.t.file(this.t.program([this.t.isStatement(e)?e:this.t.expressionStatement(e)]))}isAttrFromFunction(e,t){let i=e.parentPath,s=r=>this.t.isIdentifier(r)?r.name===t:this.t.isAssignmentPattern(r)?s(r.left):this.t.isArrayPattern(r)?r.elements.filter(Boolean).map(n=>s(n)).includes(!0):this.t.isObjectPattern(r)?r.properties.filter(n=>this.t.isObjectProperty(n)&&this.t.isIdentifier(n.key)).map(n=>n.key.name).includes(t):this.t.isRestElement(r)?s(r.argument):!1;for(;i;){let r=i.node;if(this.t.isArrowFunctionExpression(r)||this.t.isFunctionDeclaration(r)){for(let n of r.params)if(s(n))return!0}i=i.parentPath}return!1}isStandAloneIdentifier(e){let t=e.node,i=e.parentPath?.node;if(this.t.isMemberExpression(i)&&i.property===t||this.isAttrFromFunction(e,t.name))return!1;for(;e.parentPath;){if(this.t.isVariableDeclarator(e.parentPath.node)||this.t.isObjectProperty(e.parentPath.node)&&e.parentPath.node.key===e.node&&!e.parentPath.node.computed)return!1;e=e.parentPath}return!0}getIdentifiers(e){if(this.t.isIdentifier(e))return[e.name];let t=new Set;return this.traverse(this.valueWrapper(e),{Identifier:i=>{this.isStandAloneIdentifier(i)&&t.add(i.node.name)}}),[...t]}isAssignmentExpressionLeft(e){let t=e.parentPath?.node;return this.t.isAssignmentExpression(t)&&t.left===e.node||this.t.isUpdateExpression(t)}isAssignmentExpressionRight(e,t){let i=e.node,s=!1,r=e.parentPath;for(;r&&r.node!==t;){if(this.t.isAssignmentExpression(r.node)){let n=r.node.left,a=i.type===n.type,o=i.property.name===n.property.name;s=a&&o}r=r.parentPath}return s}isMemberInEscapeFunction(e,t){let i=!1,s=e.parentPath;for(;s&&s.node!==t;){let r=s.node;if(this.t.isCallExpression(r)&&this.t.isIdentifier(r.callee)&&c.escapeNamings.includes(r.callee.name)){i=!0;break}s=s.parentPath}return i}isMemberInManualFunction(e,t){let i=!1,s=e.parentPath;for(;s&&s.node!==t;){let r=s.node,n=s.parentPath?.node,a=this.t.isFunctionExpression(r)||this.t.isArrowFunctionExpression(r),o=this.t.isCallExpression(n)&&this.t.isIdentifier(n.callee)&&n.callee.name==="manual";if(a&&o){i=!0;break}s=s.parentPath}return i}static uid(e=4){return Math.random().toString(32).slice(2,e+2)}},u=c;m(u,"defaultHTMLTags",["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","slot","small","source","span","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr","acronym","applet","basefont","bgsound","big","blink","center","dir","font","frame","frameset","isindex","keygen","listing","marquee","menuitem","multicol","nextid","nobr","noembed","noframes","param","plaintext","rb","rtc","spacer","strike","tt","xmp","animate","animateMotion","animateTransform","circle","clipPath","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","foreignObject","g","image","line","linearGradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialGradient","rect","set","stop","svg","switch","symbol","text","textPath","tspan","use","view"]),m(u,"availableDecoNames",["Static","Prop","Env","Content","Children"]),m(u,"dlightDefaultPackageName","@dlightjs/dlight"),m(u,"importMap",Object.fromEntries(["createTemplate","setStyle","setDataset","setEvent","setHTMLProp","setHTMLAttr","setHTMLProps","setHTMLAttrs","insertNode","createElement","ForNode","CondNode","EnvNode","createTextNode","updateText","ExpNode","PropView"].map((e,t)=>I?[e,e]:[e,`$${t}$`]))),m(u,"escapeNamings",["escape","$"]);var k=u;function S(l,e){let{types:t}=l,{files:i="**/*.{js,jsx,ts,tsx}",excludeFiles:s="**/{dist,node_modules,lib}/*.{js,ts}",enableDevTools:r=!1,htmlTags:n=o=>o}=e,a=new k(l,t,Array.isArray(i)?i:[i],Array.isArray(s)?s:[s],r,n);return{visitor:{Program:{enter(o,{filename:d}){return a.programEnterVisitor(o,d)},exit:a.programExitVisitor.bind(a)},ClassDeclaration:{enter:a.classEnter.bind(a),exit:a.classExit.bind(a)},ClassExpression:{enter:a.classEnter.bind(a),exit:a.classExit.bind(a)},ClassMethod:a.classMethodVisitor.bind(a),ClassProperty:a.classPropertyVisitor.bind(a)}}}function _(l,e){return{plugins:[A.default,[D.default.default??D.default,{legacy:!0}],[S,e]]}}
//# sourceMappingURL=index.cjs.map